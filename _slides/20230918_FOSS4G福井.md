---
{
  "title": "他天体 における Cesiumの活用 ― Cesiumを使って小惑星に行こう― 2023/9/18 株式会社ノーザンシステムサービス 和山 亮介",
  "pages": [
    {
      "text": "他天体 における Cesiumの活用 ― Cesiumを使って小惑星に行こう― 2023/9/18 株式会社ノーザンシステムサービス 和山 亮介",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-01.jpg",
      "links": [

      ]
    },
    {
      "text": "目次 • 自己紹介 • JADEってなあに • 試行錯誤の軌跡 • 改修１: 画像の撮影範囲（フットプリント）を Cesium で表示する • 改修２: 地名（POI）が正しく表示されるようにする • 改修３:撮影画像を天体表面に貼り付け表示可能にする • まとめ 2",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-02.jpg",
      "links": [

      ]
    },
    {
      "text": "自己紹介 岩手にある (株)ノーザンシステムサービス という会社で 地図やAIを使ったりした研究 開発やリサーチをしています。 最近はバイクで聖地巡礼した りしております。 Twitter： @wayama_ryousuke 3",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-03.jpg",
      "links": [

      ]
    },
    {
      "text": "小惑星探査機「はやぶさ2」 • JAXAが打上げた小惑星探査機 • 小惑星 リュウグウ を探査後、地球に帰還 （サンプルリターン） • 試料から 水の成分・アミノ酸 を発見 (2022)] するなど、さまざまな研究成果が発表 • 現在は拡張ミッションで別の小惑星に向けて飛行中 研究成（出典: NHK）目 今回は、その「はやぶさ2」 とGISに関するトピックをご紹介します [1] Eizo Nakamura et al., On the origin and evolution of the asteroid Ryugu: A comprehensive geochemical perspective, Proceedings of 2208, https://doi.org/10.2183/pjab.98.015画像: © JAXA/ISASstage.jst.go.jp/article/pjab/98/6/98_PJA9806B-01/_article/-char/enN 0386-",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-04.jpg",
      "links": [

      ]
    },
    {
      "text": "今回の発表について 今からおよそ半年前... JAXA（宇宙航空研究開発機構）様からのご依頼により ジ ェ イ ド 「JADE」の改修 を実施 でも… JADEってなんだ？ 5",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-05.jpg",
      "links": [

      ]
    },
    {
      "text": "JADEってなあに 説明しよう！ [1] JADE (JAXA Asteroid Data Explorer) © ISAS/JAXA • 探査機「はやぶさ2」が取得した 小惑星リュウグウの データを表示・検索するシステム • Cesium ベースなので 2D/3D 表示ができる • 元データ（ONC画像）は オープンデータ [2] （政府標準利用規約 第2.0版） リュウグウをぐりぐり回せる3Dビュー [2] https://www.darts.isas.jaxa.jp/planet/project/hayabusa2/list.htmlsra.edu/meetings/lpsc2023/pdf/2001.pdf)",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-06.jpg",
      "links": [
        {
          "url": "https://www.hou.usra.edu/meetings/lpsc2023/pdf/2001.pdf",
          "position_str": "top:91.84%;left:38.58%;bottom:5.56%;right:20.68%;"
        },
        {
          "url": "https://www.darts.isas.jaxa.jp/planet/project/hayabusa2/list.html",
          "position_str": "top:94.95%;left:6.75%;bottom:2.44%;right:48.43%;"
        }
      ]
    },
    {
      "text": "JADEってなあに 1. 画像の撮影範囲フットプリント ）をCesium 上で表示する おもな 2. 撮影画像を天体表面に貼り付け表示 可能にする 改修内容 3. リュウグウ地名（POI） が正しく表示されるようにする etc… Cesium案件で培った経験でいけそうと判断したが… 7",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-07.jpg",
      "links": [

      ]
    },
    {
      "text": "今回の発表について Cesium で地球以外の天体（他天体）を 表示する事例は少ない！ Google 先生もお手上げ 今回は、直面した課題と、手探りで模索した解決策を発表します 8",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-08.jpg",
      "links": [

      ]
    },
    {
      "text": "1 D 改修 1 N 画像Cesium で表示するト）を U O 9",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-09.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目1: フットプリントの表示 改修前 • 撮影範囲（フットプリント）のポリゴンデータはあるが、 一部のポリゴンが壊れている • この結果、フットプリントの 表示・範囲検索が正しく動作しない 実際の この検索領域 検索領域 撮影範囲 でもヒットする 大きな岩の付近で、 撮影範囲にかかわらず、範囲検索がヒットしてしまう ポリゴンの辺が自己交差している （部分拡大） 岩 10",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-10.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目1: フットプリントの表示 したいこと • 経度0度をまたぐ部分・飛び地も含めて、表示し、正しく範囲検索可能にする ※ GeoTIFFなどの一般的なデータと異なり、 各画素に経度・緯度が付与 されている WKT DB ポリゴン (PostGIS) 元画像チャネル 経度チャネル 緯度チャネル （グレースケール） FITSデータ（多チャネル画像） 11",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-11.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目1: フットプリントの表示 最初のアイディア 画素を2D平面にプロットして、ポリゴン化すればいいんじゃない？ どうだ！ （ドヤ顔） • 点群のポリゴン化には点群から凹領域を作成するアルゴリズムで ある AlphaShapeを使用 WKT DB ポリゴン (PostGIS) バックプレーン情報 画素を2D平面にプロット ポリゴン化 （FITS形式） （点群化） [1] https://github.com/bellockk/alphashape 12",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-12.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目1: フットプリントの表示 最初のアイディア 画素を2D平面にプロットして、ポリゴン化すればいいんじゃない？ 問題点 1. 図法の性質上、極付近では点群が疎になり、ポリゴンが形成されない 2. 図法の性質上、地図の両端（経度0度 ）でポリゴンが分割される 3. 遠距離から撮影した画像では、点群が疎になり、ポリゴンが形成されない 両端でポリゴンが分割される 点群密度が このあたりの点群が薄いので 画像によって ポリゴンができない 異なる [1] リュウグウの経度軸は0度～360度をとり、東経・西経をもつ地球（-180～180度）とは異なる。 13",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-13.jpg",
      "links": [

      ]
    },
    {
      "text": " 改修項目1: フットプリントの表示 第２のアイディア モルワイデ図法なら、極付近でも点群が疎になりにくいのでは？ → 点群をモルワイデ図法に再投影して、ポリゴンを生成してから、 ゴ 投影法を戻す 利用した AstroPy] AlphaShape] OSSライブラリ NumPy[2] Cartopy Shapely] PyProj6] 正距円筒図法に FITS ポリゴン データ 生成 再投影して WKTへ変換 正距円筒図法 モルワイデ図法 ※ 点群の重心を再投影後の中心にする ※ アルファシェイプの ※ ランベルト正積方位図法も試したが、 パラメータ（α）は 正距円筒図法への再投影時にポリゴンが 点群密度に応じて どうしても壊れるので却下 動的に変更 [4] AlphaShape (https://github.com/bellockk/alphashape) [5] Shapely (https://github.com/shapely/shapely) [6] PyProj (https://github.com/pyproj4/pyproj)",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-14.jpg",
      "links": [
        {
          "url": "https://www.astropy.org/",
          "position_str": "top:93.97%;left:10.86%;bottom:3.78%;right:74.34%;"
        },
        {
          "url": "https://numpy.org/",
          "position_str": "top:93.97%;left:33.52%;bottom:3.78%;right:55.33%;"
        },
        {
          "url": "https://github.com/SciTools/cartopy",
          "position_str": "top:93.97%;left:52.87%;bottom:3.78%;right:25.84%;"
        },
        {
          "url": "https://github.com/bellockk/alphashape",
          "position_str": "top:96.64%;left:13.33%;bottom:0%;right:63.13%;"
        },
        {
          "url": "https://github.com/shapely/shapely",
          "position_str": "top:96.64%;left:45.18%;bottom:0%;right:33.86%;"
        },
        {
          "url": "https://github.com/pyproj4/pyproj",
          "position_str": "top:96.64%;left:73.65%;bottom:0%;right:6.4%;"
        }
      ]
    },
    {
      "text": "改修項目1: フットプリントの表示 続 も な こ 第２のアイディア く う い れ 点群をモルワイデ図法に再投影して、ポリゴンを生成してから、 ん ち ぞ で じ っ よ 完 投影法を戻す ゃ と 成 （モルワイデ図法なら、極付近でも点群が疎になりにくいはず…） だ じ け ゃ 正距円筒図法に投影 モルワイデ図法に ポリゴン生成 正距円筒図法に戻すと… 再投影 いい感じのポリゴンができた！ その他の工夫 • 正距円筒図法に戻したとき、経度0度をまたぐ辺が壊れる → Proj の +over オプションを使って再投影し、Shapely の make_valid() 関数でポリゴンを修復 地図からはみ出したポリゴンは、Shapely で整形 • 経度0度で分割線が生じる → ポリゴンを LINESTRING に変換し、後処理で除去 15",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-15.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目1: フットプリントの表示 だが、さらなる問題が… 他天体では崩壊 地球だとOKなのだが… ① Cesium でポリゴンが正常に表示されない • 楕円体設定が地球以外のときだけ、ポリゴン表示が崩れる • 複雑で大きいポリゴンのみ起こる （POIはなぜか問題なし[後述]） • 輪郭線（LINESTRING）だけなら表示できるので、 輪郭線だけの表示に変更 地球以外の楕円体では 輪郭線表示は ポリゴンが崩壊 OKなんだけどね… ② 輪郭線が地面に埋もれる 見えるように • 楕円体設定が地球以外のときに、線を地面に這わせると 埋もれている なった （Cesium の clampToGround）、地面に埋もれる • clampToGround を解除して、 輪郭線の各頂点に高さ情報（Z座標）を与えることで解決 残念ながら、この方法も完璧ではありません。 各頂点に高さ情報を付与すると、地面に隠れるはずの 地面に這わせる設定 頂点に高さ情報を与えると 輪郭線が表示される場合があります。うーむ… ここは地平線の陰に 埋もれる きれいに輪郭線が出ます な透視できるに 16",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-16.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目1: フットプリントの表示 いくつもの試行錯誤と工夫を経て… フットプリントが 正しく表示・検索できるようになった 外周線のみ表示 線が地形に 埋もれない 検索結果にヒットする 経度0/360度には 線が表示されない フットプリント表示 (3D) 領域検索(2D) 17",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-17.jpg",
      "links": [

      ]
    },
    {
      "text": "2 D 改修 2 N 天体表面に貼り付け表示可能にする U O 18",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-18.jpg",
      "links": [

      ]
    },
    {
      "text": " 改修項目2: 画像貼り付け機能 • リュウグウの撮影画像を地図上に表示する • Cesiumの画像レイヤーで表示するため、天体を撮影した画像を 円筒図法で展開された画像に変換 • 撮影画像の各画素に緯度経度情報が保持されていることから、 緯度、経度、画素値の点群データを作成 [1] • 点群データをグラフ描画ライブラリmatplotlib で展開図にプロット X Y Z 111.920 78.928 0.001 113.036 79.115 0.001 113.695 79.333 0.001lotlibで 114.014 79.577 0.001ト 114.222 79.830 0.001 経度 緯度 … 生成画像 点群データ 撮影画像（位置情報を含む多次元データ） （X:経度 Y:緯度 Z:画素値） 19 [1] Python向けのグラフ描画ライブラリ https://matplotlib.org/",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-19.jpg",
      "links": [
        {
          "url": "https://matplotlib.org/",
          "position_str": "top:96.71%;left:23.39%;bottom:1.04%;right:63.54%;"
        }
      ]
    },
    {
      "text": "改修項目2: 画像貼り付け機能 • 問題点：点群が疎である場合、隙間が空いてしまう • 極付近が含まれた画像、 撮影距離が遠く 元の撮影画像の天体の解像度が低い画像は 点群が疎になりがち 展開 点群は 全体的に スカスカ これが リュウグウ 点群が疎な展開画像 20",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-20.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目2: 画像貼り付け機能 • 問題点：点群が疎である場合、隙間が空いてしまう • 極付近が含まれた画像、 撮影距離が遠く 元の撮影画像の天体の解像度が低い画像は 点群が疎になりがち 展開 極付近はスカスカ 極付近が含まれる撮影画像 極付近の点群が疎な展開画像 21",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-21.jpg",
      "links": [

      ]
    },
    {
      "text": " 改修項目2: 画像貼り付け機能 • 解決法①：解像度を下げる • 撮影画像の写っている天体の大きさに基づいて生成画像の解像度を調整することで、 撮影距離が遠いものについては解像度を下げる • デメリット： • 解像度が小さいためプロットされる点の円が目立ってしまう • 被写体の天体の大きさに基づいて解像度を調整するため、 撮影距離が遠いもののみについての対応 （極付近の点群が疎になる画像は解像度が高くなりこの手法では対応できない） 撮影距離が遠い撮影画像 点群が疎な展開画像 解像度を調整して生成した展開画像 22",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-22.jpg",
      "links": [

      ]
    },
    {
      "text": " 改修項目2: 画像貼り付け機能 • 解決法①：解像度を下げる • 撮影画像の写っている天体の大きさに基づいて生成画像の解像度を調整することで、 撮影距離が遠いものについては解像度を下げる • デメリット： • 解像度が小さいためプロットされる点の円が目立ってしまう • 被写体の天体の大きさに基づいて解像度を調整するため、 撮影距離が遠いもののみについての対応 （極付近の点群が疎になる画像は解像度が高くなりこの手法では対応できない） 画像内で 疎密が異なると 対応できない 極付近が含まれる撮影画像 極付近の点群が疎な展開画像 解像度を調整して生成した展開画像 23",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-23.jpg",
      "links": [

      ]
    },
    {
      "text": " 改修項目2: 画像貼り付け機能 • 解決法②：点群を補間する [1] • 地図作成ツールGMT のnearneighborで点群を補間してGridデータ化 • 補間時のパラメータは簡易的に点群密度を計算して動的に調整 • この手法であれば遠距離から撮影した画像も極付近の画像も対応可能 • デメリット： • あまりにも点間の距離が空いていると補間できない • 補間により表示される領域が一回り大きくなるため、撮影領域の線と重ねるとはみ出す場合がある • 今回はこちらの手法を採用 撮影距離が遠い撮影画像 点群が疎な展開画像 点群を補間して生成した展開画像 [1] the Gener本来は地図を描画するツールだが、Gridデータを操作する機能が充実しているため、データの変24生成に使うこともある https://www.generic-mapping-tools.org/",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-24.jpg",
      "links": [
        {
          "url": "https://www.generic-mapping-tools.org/",
          "position_str": "top:0%;left:2.88%;bottom:0%;right:73.5%;"
        }
      ]
    },
    {
      "text": " 改修項目2: 画像貼り付け機能 • 解決法②：点群を補間する [1] • 地図作成ツールGMT のnearneighborで点群を補間してGridデータ化 • 補間時のパラメータは簡易的に点群密度を計算して動的に調整 • この手法であれば遠距離から撮影した画像も極付近の画像も対応可能 • デメリット： • あまりにも点間の距離が空いていると補間できない • 補間により表示される領域が一回り大きくなるため、撮影領域の線と重ねるとはみ出す場合がある • 今回はこちらの手法を採用 極付近が含まれる撮影画像 極付近の点群が疎な展開画像 点群を補間して生成した展開画像 [1] the Gener本来は地図を描画するツールだが、Gridデータを操作する機能が充実しているため、データの変25生成に使うこともある https://www.generic-mapping-tools.org/",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-25.jpg",
      "links": [
        {
          "url": "https://www.generic-mapping-tools.org/",
          "position_str": "top:0%;left:2.88%;bottom:0%;right:73.5%;"
        }
      ]
    },
    {
      "text": " 改修項目2: 画像貼り付け機能 [1] • 生成した画像をCesiumの SingleTileImageryProvider で地図上に表示 • DBに保存されている撮影領域の座標値から表示範囲を取得 撮影画像 2D地図上に画像表示 3D地図上に画像表示 画像を天体表面に貼り付けて表示 できるようになった 🎉🥳 26 [1] 表示範囲を指定して1枚の画像を地図上に表示するCesiumの機能 https://cesium.com/learn/cesiumjs/ref-doc/SingleTileImageryProvider.html",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-26.jpg",
      "links": [
        {
          "url": "https://cesium.com/learn/cesiumjs/ref-doc/SingleTileImageryProvider.html",
          "position_str": "top:96.82%;left:39.38%;bottom:0.93%;right:16.59%;"
        }
      ]
    },
    {
      "text": "3 D 改修3 N 正しく表示されるようにする U O 27",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-27.jpg",
      "links": [

      ]
    },
    {
      "text": " 改修項目3: 地名の位置ずれ修正 したいこと 地名やクレーターなどを表すラベルやポリゴン等が地形に埋まっている → 地形に沿うような表示に調整したい セ地 シ形 私 そ ムに も な に あ ふ あ沿 り う る… ま に … し 考 実 る た え 装 [て] は 機 い 秒 能 た 殺… は クレーターを示すポリゴン 時 … が地形に埋まってしまって 期 いる が ！ 28 [1] 「このネタ、過去のFOSS4Gで見たことあるな…」とお気づきの方は、素晴らしい記憶力をお持ちです。当社は、9年前の FOSS4G 2014 Tokyo でも同じ刃牙ネタを使っていました",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-28.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目3: 地名の位置ずれ修正 クレーターのポリゴンを 地形に沿わせる設定 にして表示 ポリゴンが…消えた…？ 29",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-29.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目3: 地名の位置ずれ修正 消えたポリゴンを探してみると、 とんでもなく遠いところに表示 されてる • 原因としては、 ポリゴンが元のWGS84の設定、つまり 地球の楕円体上に表示される 設定になっていることが考えられる • しかし楕円体の設定は リュウグウの値で設定されていることを 確認済み クレーターの この辺に ポリゴン リュウグウ 30",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-30.jpg",
      "links": [

      ]
    },
    {
      "text": "改修項目3: 地名の位置ずれ修正 • 調査したところ、楕円体の設定をWGS84以外に設定しても 内部の計算をWGS84で行っている部分がある らしい • CesiumのWGS84の値をリュウグウの楕円体に書き換えて対応 クレーターを 地形に沿って 表示できるようになった！ Cesiumの開発者も言及 that way everything will just work. もう 1 つのオプションは、Cesium.Ellipsoid.WGS84 の定 義を変更して、Callipso と一致するようにすることです。 そうすれば、すべてが正常に機能します。 31",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-31.jpg",
      "links": [

      ]
    },
    {
      "text": "H C さまざまな試行錯誤の結果… N A 32",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-32.jpg",
      "links": [

      ]
    },
    {
      "text": " JADEへのアクセスはこちらから 難題を乗り越えて JADEは無事に公開されました！ 大学や研究機関の研究者からは 高頻度にアクセスしていただき 高い評価を得ています 使いやすくなった 他天体でも 作ってほしい https://jade.darts.isas.jaxa.jp/ 他天体ならではの FOSS４Gライブラリの または「JAXA JADE」 で検索 管理者・開発者様に感謝！🙏🙇 知見が得られました JAXA様にも感謝！ 33",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-33.jpg",
      "links": [
        {
          "url": "https://jade.darts.isas.jaxa.jp/",
          "position_str": "top:78.4%;left:61.46%;bottom:18.63%;right:15.11%;"
        }
      ]
    },
    {
      "text": "最後に…教訓 1. Cesiで他天体 を表示することは できる 2. ただしCes一部機能は壊れる （Issue にもない！） 3. 点群からのポリゴン生成・画像補完時は、疎な点群 と極付近 に気を付ける 4. ハードコードされ地球を前提とする定数 に注意！ 他天体を含めた2D/3D地図を使ったWebアプリ開発は、 ノーザンシステムサービスにご用命ください！ 改修内容の発表について、JAXA様にご快諾いただきました。 感謝申し上げます！ 34",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-34.jpg",
      "links": [

      ]
    },
    {
      "text": " ご清聴ありがとうございました! 他天体における Cesium の活用 ― Cesiumを使って小惑星に行こう― 2023/9/18 株式会社ノーザンシステムサービス 和山 亮介 リュウグウの水で乾杯したい",
      "width": 960,
      "height": 540,
      "image": "20230918_FOSS4G福井/slide-35.jpg",
      "links": [

      ]
    }
  ]
}
---
